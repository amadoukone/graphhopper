name: Build and Test

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24, 25-ea ]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-
      
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test

  mutation-testing:
    name: Mutation Testing (Core Module)
    runs-on: ubuntu-latest
    needs: build  # Attend que le build soit OK
    timeout-minutes: 120
    # N'exÃ©cuter que sur la branche principale et les PRs
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout current commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 24  # Utiliser la mÃªme version que le build principal
          distribution: temurin
      
      - name: Configure Maven
        run: |
          mkdir -p .mvn
          cat > .mvn/maven.config << 'EOF'
          -B
          --no-transfer-progress
          EOF
          
          cat > .mvn/jvm.config << 'EOF'
          -Xmx4096m
          -Xms1024m
          EOF
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Build project
        run: mvn clean install -DskipTests
      
      - name: Detect changed Java classes in core module
        id: changed-files
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         DETECTING CHANGED JAVA CLASSES            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if ! git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "âš ï¸  First commit or shallow clone - testing all classes"
            echo "has_changes=all" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # RÃ©cupÃ©rer tous les fichiers Java modifiÃ©s (source et test)
          ALL_JAVA_FILES=$(git diff --name-only HEAD^ HEAD | grep '^core/src/.*/.*\.java$' || true)
          
          if [ -z "$ALL_JAVA_FILES" ]; then
            echo "âœ… No Java files changed in core module"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“„ Changed files:"
          echo "$ALL_JAVA_FILES" | sed 's/^/  - /'
          echo ""
          
          # Extraire les classes Ã  tester
          CLASSES_TO_TEST=""
          
          # 1. Ajouter les classes source modifiÃ©es
          for file in $ALL_JAVA_FILES; do
            if [[ "$file" =~ ^core/src/main/java/(.*)\.java$ ]]; then
              class_name="${BASH_REMATCH[1]}"
              class_name="${class_name//\//.}"
              CLASSES_TO_TEST="$CLASSES_TO_TEST$class_name"$'\n'
              echo "  âž• Source: $class_name"
            fi
          done
          
          # 2. Pour les tests modifiÃ©s, ajouter leur classe source correspondante
          for file in $ALL_JAVA_FILES; do
            if [[ "$file" =~ ^core/src/test/java/(.*)Test\.java$ ]]; then
              class_name="${BASH_REMATCH[1]}"
              class_name="${class_name//\//.}"
              
              # VÃ©rifier si la classe source existe
              source_file="core/src/main/java/${BASH_REMATCH[1]}.java"
              if [ -f "$source_file" ]; then
                CLASSES_TO_TEST="$CLASSES_TO_TEST$class_name"$'\n'
                echo "  âž• Test modified â†’ Testing source: $class_name"
              else
                echo "  âš ï¸  Test modified but no source found: $class_name"
              fi
            fi
          done
          
          # Supprimer les doublons et les lignes vides
          CLASSES_TO_TEST=$(echo "$CLASSES_TO_TEST" | sort -u | grep -v '^$')
          
          if [ -z "$CLASSES_TO_TEST" ]; then
            echo ""
            echo "âœ… No testable classes found"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          NUM_CLASSES=$(echo "$CLASSES_TO_TEST" | wc -l)
          CLASSES_FOR_PIT=$(echo "$CLASSES_TO_TEST" | tr '\n' ',' | sed 's/,$//')
          
          echo ""
          echo "ðŸŽ¯ Classes to test ($NUM_CLASSES):"
          echo "$CLASSES_TO_TEST" | sed 's/^/  - /'
          echo ""
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "classes=$CLASSES_FOR_PIT" >> $GITHUB_OUTPUT
          echo "count=$NUM_CLASSES" >> $GITHUB_OUTPUT
          
          echo "$CLASSES_TO_TEST" > changed-classes.txt
      
      - name: Run mutation testing on changed classes
        if: steps.changed-files.outputs.has_changes == 'true'
        id: run-current-pit
        run: |
          set +e
          cd core
          
          CLASSES="${{ steps.changed-files.outputs.classes }}"
          NUM_CLASSES="${{ steps.changed-files.outputs.count }}"
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    MUTATION TESTING ON CHANGED CLASSES ($NUM_CLASSES)       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Starting at: $(date)"
          echo "Available memory: $(free -h | grep Mem)"
          echo ""
          
          # Lancer PIT uniquement sur les classes modifiÃ©es
          mvn org.pitest:pitest-maven:mutationCoverage \
            -DargLine="-Xmx6144m -Xms2048m -Duser.language=en" \
            -DtargetClasses="$CLASSES" \
            2>&1 | tee pit-output.log
          
          EXIT_CODE=$?
          
          echo ""
          echo "Finished at: $(date)"
          echo ""
          
          # VÃ©rifier si un rapport a Ã©tÃ© gÃ©nÃ©rÃ©
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            
            # Analyser les problÃ¨mes rencontrÃ©s
            MEMORY_ERRORS=$(grep -c "MEMORY_ERROR" pit-output.log || echo "0")
            TIMEOUT_ERRORS=$(grep -c "TIMED_OUT" pit-output.log || echo "0")
            
            echo "memory_errors=$MEMORY_ERRORS" >> $GITHUB_OUTPUT
            echo "timeout_errors=$TIMEOUT_ERRORS" >> $GITHUB_OUTPUT
            
            if [ "$MEMORY_ERRORS" -gt 0 ] || [ "$TIMEOUT_ERRORS" -gt 0 ]; then
              echo "âš ï¸  Report generated with issues:"
              echo "   - Memory errors: $MEMORY_ERRORS"
              echo "   - Timeouts: $TIMEOUT_ERRORS"
            else
              echo "âœ… Report generated successfully"
            fi
            
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ No mutation report generated"
            echo ""
            echo "=== Last 100 lines of output ==="
            tail -100 pit-output.log
            exit 1
          fi
      
      - name: Run mutation testing on all classes (fallback)
        if: steps.changed-files.outputs.has_changes == 'all'
        id: run-current-pit-all
        run: |
          set +e
          cd core
          
          echo "âš ï¸  Testing ALL classes (first commit or no parent)"
          
          mvn org.pitest:pitest-maven:mutationCoverage \
            -DargLine="-Xmx6144m -Xms2048m -Duser.language=en" \
            2>&1 | tee pit-output.log
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Skip mutation testing
        if: steps.changed-files.outputs.has_changes == 'false'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         NO JAVA CLASSES CHANGED - SKIPPING        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… No mutation testing needed for this commit"
      
      - name: Extract current mutation score
        id: current-score
        if: |
          (steps.run-current-pit.outputs.success == 'true' || 
           steps.run-current-pit-all.outputs.success == 'true')
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SURVIVED=$(grep -o "status='SURVIVED'" "$MUTATION_FILE" | wc -l)
          TIMEOUT=$(grep -o "status='TIMED_OUT'" "$MUTATION_FILE" | wc -l || echo "0")
          MEMORY=$(grep -o "status='MEMORY_ERROR'" "$MUTATION_FILE" | wc -l || echo "0")
          NO_COVERAGE=$(grep -o "status='NO_COVERAGE'" "$MUTATION_FILE" | wc -l || echo "0")
          
          SCORE=$((TOTAL > 0 ? KILLED * 100 / TOTAL : 0))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
          echo "timeout=$TIMEOUT" >> $GITHUB_OUTPUT
          echo "memory=$MEMORY" >> $GITHUB_OUTPUT
          echo "no_coverage=$NO_COVERAGE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         CURRENT COMMIT MUTATION RESULTS           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  Total mutants:      $TOTAL"
          echo "  âœ… Killed:          $KILLED ($SCORE%)"
          echo "  âŒ Survived:        $SURVIVED"
          echo "  â±ï¸  Timed out:       $TIMEOUT"
          echo "  ðŸ’¾ Memory errors:   $MEMORY"
          echo "  ðŸš« No coverage:     $NO_COVERAGE"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Save current mutation report
        if: steps.current-score.outputs.found == 'true'
        run: |
          mkdir -p mutation-reports/current
          cp -r core/target/pit-reports/* mutation-reports/current/ 2>/dev/null || true
          
          if [ -f changed-classes.txt ]; then
            cp changed-classes.txt mutation-reports/current/
          fi
      
      - name: Check parent commit
        id: check-parent
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "commit=$(git rev-parse HEAD^)" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: |
          git checkout ${{ steps.check-parent.outputs.commit }}
      
      - name: Build parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: mvn clean install -DskipTests
      
      - name: Run mutation testing on parent (same classes)
        if: steps.check-parent.outputs.exists == 'true'
        id: run-parent-pit
        run: |
          set +e
          cd core
          
          CLASSES="${{ steps.changed-files.outputs.classes }}"
          
          echo "Testing parent commit on same classes..."
          
          mvn org.pitest:pitest-maven:mutationCoverage \
            -DargLine="-Xmx6144m -Xms2048m -Duser.language=en" \
            -DtargetClasses="$CLASSES" \
            2>&1 | tee pit-parent-output.log
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Parent report generated"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Could not generate parent report"
          fi
          exit 0
      
      - name: Extract parent mutation score
        id: parent-score
        if: steps.check-parent.outputs.exists == 'true' && steps.run-parent-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SURVIVED=$(grep -o "status='SURVIVED'" "$MUTATION_FILE" | wc -l)
          
          SCORE=$((TOTAL > 0 ? KILLED * 100 / TOTAL : 0))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
          
          echo "Parent: $KILLED/$TOTAL killed ($SCORE%)"
      
      - name: Compare scores and determine result
        if: steps.current-score.outputs.found == 'true'
        id: comparison
        run: |
          CURRENT=${{ steps.current-score.outputs.score }}
          CURRENT_KILLED=${{ steps.current-score.outputs.killed }}
          CURRENT_TOTAL=${{ steps.current-score.outputs.total }}
          NUM_CLASSES="${{ steps.changed-files.outputs.count }}"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           MUTATION TESTING COMPARISON             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Classes tested: $NUM_CLASSES"
          echo ""
          echo "Current commit: $CURRENT_KILLED/$CURRENT_TOTAL killed ($CURRENT%)"
          
          if [ "${{ steps.parent-score.outputs.found }}" == "true" ]; then
            PARENT=${{ steps.parent-score.outputs.score }}
            PARENT_KILLED=${{ steps.parent-score.outputs.killed }}
            PARENT_TOTAL=${{ steps.parent-score.outputs.total }}
            DIFF=$((CURRENT - PARENT))
            
            echo "Parent commit:  $PARENT_KILLED/$PARENT_TOTAL killed ($PARENT%)"
            echo ""
            echo "Difference: ${DIFF}% (${CURRENT}% - ${PARENT}%)"
            echo ""
            
            if [ $CURRENT -lt $PARENT ]; then
              echo "result=decreased" >> $GITHUB_OUTPUT
              echo "âŒ FAILURE: Mutation score DECREASED from $PARENT% to $CURRENT%"
              echo ""
              echo "Your changes reduced test quality for the modified classes."
              echo "Please add tests to kill more mutants before merging."
              exit 1
            elif [ $CURRENT -eq $PARENT ]; then
              echo "result=maintained" >> $GITHUB_OUTPUT
              echo "âœ… SUCCESS: Mutation score MAINTAINED at $CURRENT%"
            else
              echo "result=improved" >> $GITHUB_OUTPUT
              echo "ðŸŽ‰ SUCCESS: Mutation score IMPROVED from $PARENT% to $CURRENT%!"
              echo ""
              echo "Great job! You killed $((CURRENT_KILLED - PARENT_KILLED)) more mutants!"
            fi
          else
            echo "result=baseline" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… SUCCESS: Baseline established at $CURRENT%"
            echo ""
            echo "No parent commit available for comparison."
          fi
      
      - name: Upload mutation reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-reports
          path: |
            mutation-reports/
            core/target/pit-reports/
            core/*.log
            changed-classes.txt
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.current-score.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = {
              score: parseInt('${{ steps.current-score.outputs.score }}'),
              killed: parseInt('${{ steps.current-score.outputs.killed }}'),
              total: parseInt('${{ steps.current-score.outputs.total }}'),
              survived: parseInt('${{ steps.current-score.outputs.survived }}'),
              timeout: parseInt('${{ steps.current-score.outputs.timeout }}'),
              memory: parseInt('${{ steps.current-score.outputs.memory }}'),
              noCoverage: parseInt('${{ steps.current-score.outputs.no_coverage }}')
            };
            
            const numClasses = parseInt('${{ steps.changed-files.outputs.count }}');
            const hasParent = '${{ steps.parent-score.outputs.found }}' === 'true';
            
            let body = `## ðŸ§¬ Mutation Testing Results\n\n`;
            body += `**Scope:** ${numClasses} modified class${numClasses !== 1 ? 'es' : ''} in core module\n\n`;
            
            if (hasParent) {
              const parent = {
                score: parseInt('${{ steps.parent-score.outputs.score }}'),
                killed: parseInt('${{ steps.parent-score.outputs.killed }}'),
                total: parseInt('${{ steps.parent-score.outputs.total }}'),
                survived: parseInt('${{ steps.parent-score.outputs.survived }}')
              };
              
              const diff = current.score - parent.score;
              const killedDiff = current.killed - parent.killed;
              const survivedDiff = current.survived - parent.survived;
              
              let statusEmoji = 'âšª';
              let statusText = 'maintained';
              
              if (diff < 0) {
                statusEmoji = 'ðŸ”´';
                statusText = 'decreased';
              } else if (diff > 0) {
                statusEmoji = 'ðŸŸ¢';
                statusText = 'improved';
              }
              
              body += `| Metric | Parent | Current | Diff |\n`;
              body += `|--------|--------|---------|------|\n`;
              body += `| **Mutation Score** | ${parent.score}% | ${current.score}% | ${statusEmoji} ${diff > 0 ? '+' : ''}${diff}% |\n`;
              body += `| **Killed** | ${parent.killed}/${parent.total} | ${current.killed}/${current.total} | ${killedDiff > 0 ? '+' : ''}${killedDiff} |\n`;
              body += `| **Survived** | ${parent.survived} | ${current.survived} | ${survivedDiff > 0 ? '+' : ''}${survivedDiff} |\n\n`;
              
              body += `### ${statusEmoji} Status: **${statusText}**\n\n`;
              
              if (diff < 0) {
                body += `âš ï¸ **Action required:** The mutation score decreased. Please improve tests for the modified classes.\n\n`;
              } else if (diff > 0) {
                body += `ðŸŽ‰ **Excellent!** You killed ${killedDiff} more mutant${killedDiff !== 1 ? 's' : ''}!\n\n`;
              }
            } else {
              body += `| Metric | Value |\n`;
              body += `|--------|-------|\n`;
              body += `| **Mutation Score** | ${current.score}% |\n`;
              body += `| **Killed** | ${current.killed}/${current.total} |\n`;
              body += `| **Survived** | ${current.survived} |\n\n`;
              body += `âœ… Baseline mutation score established\n\n`;
            }
            
            const issues = [];
            if (current.timeout > 0) issues.push(`â±ï¸ ${current.timeout} timeout(s)`);
            if (current.memory > 0) issues.push(`ðŸ’¾ ${current.memory} memory error(s)`);
            if (current.noCoverage > 0) issues.push(`ðŸš« ${current.noCoverage} without coverage`);
            
            if (issues.length > 0) {
              body += `\n**Issues encountered:** ${issues.join(', ')}\n`;
            }
            
            body += `\n---\n`;
            body += `<details><summary>ðŸ“‹ View tested classes</summary>\n\n`;
            body += `\`\`\`\n${{ steps.changed-files.outputs.classes }}\n\`\`\`\n\n`;
            body += `</details>\n\n`;
            body += `*Mutation testing powered by [PIT](https://pitest.org/)*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });