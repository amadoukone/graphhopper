name: Build and Test
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24, 25-ea ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      
      #Cache pour la baseline du score de mutation
      - name: Cache mutation score baseline
        id: cache-mutation-baseline
        uses: actions/cache@v4
        with:
          path: .mutation-baseline
          key: mutation-baseline-${{ github.ref_name }}-java-${{ matrix.java-version }}
          restore-keys: |
            mutation-baseline-${{ github.ref_name }}-
            mutation-baseline-
      
      - name: Build and Test ${{ matrix.java-version }}
        run: mvn -B clean test
      
      #Ex√©cuter Pitest sur TOUS les modules
      - name: Run Pitest mutation testing on all modules
        run: mvn -B org.pitest:pitest-maven:mutationCoverage
      
      #Agr√©ger les rapports de tous les modules
      - name: Aggregate Pitest reports
        run: |
          # Cr√©er un r√©pertoire pour les rapports agr√©g√©s
          mkdir -p target/pit-reports-aggregate
          
          # Trouver tous les rapports index.html de tous les modules
          find . -path "*/target/pit-reports/*/index.html" -type f | while read report; do
            module_name=$(echo "$report" | sed 's|./||' | sed 's|/target/.*||')
            echo "üì¶ Trouv√© rapport pour module: $module_name"
            
            # Copier le rapport dans le dossier agr√©g√©
            mkdir -p "target/pit-reports-aggregate/$module_name"
            cp -r "$(dirname "$report")"/* "target/pit-reports-aggregate/$module_name/"
          done
          
          echo "‚úÖ Rapports agr√©g√©s dans target/pit-reports-aggregate/"
          ls -la target/pit-reports-aggregate/
      
      #Extraire le score de mutation global
      - name: Extract global mutation score
        id: extract-score
        run: |
          # Trouver tous les rapports HTML de tous les modules
          REPORT_FILES=$(find . -path "*/target/pit-reports/*/index.html" -type f)
          
          if [ -z "$REPORT_FILES" ]; then
            echo "‚ùå Aucun rapport Pitest trouv√©"
            exit 1
          fi
          
          echo "üìÑ Rapports trouv√©s :"
          echo "$REPORT_FILES"
          echo ""
          
          # Variables pour calculer le score global
          TOTAL_MUTATIONS=0
          TOTAL_KILLED=0
          
          # Parser chaque rapport pour extraire les statistiques
          while IFS= read -r report; do
            module=$(echo "$report" | sed 's|./||' | sed 's|/target/.*||')
            echo "üìä Analyse du module: $module"
            
            # Extraire le nombre de mutations et de mutations tu√©es
            # Pattern : chercher dans le XML qui est plus fiable
            xml_report="${report/index.html/mutations.xml}"
            
            if [ -f "$xml_report" ]; then
              mutations=$(grep -oP 'detected="\K\d+' "$xml_report" | awk '{s+=$1} END {print s}')
              killed=$(grep -oP 'status="KILLED"' "$xml_report" | wc -l)
              
              TOTAL_MUTATIONS=$((TOTAL_MUTATIONS + mutations))
              TOTAL_KILLED=$((TOTAL_KILLED + killed))
              
              echo "  Mutations: $mutations, Tu√©es: $killed"
            fi
          done <<< "$REPORT_FILES"
          
          echo ""
          echo "üìà Statistiques globales :"
          echo "  Total mutations : $TOTAL_MUTATIONS"
          echo "  Total tu√©es     : $TOTAL_KILLED"
          
          # Calculer le score global
          if [ "$TOTAL_MUTATIONS" -eq 0 ]; then
            GLOBAL_SCORE=0
            echo "‚ö†Ô∏è  Aucune mutation d√©tect√©e"
          else
            GLOBAL_SCORE=$((TOTAL_KILLED * 100 / TOTAL_MUTATIONS))
          fi
          
          echo "global_score=$GLOBAL_SCORE" >> $GITHUB_OUTPUT
          echo ""
          echo "üéØ Score de mutation global : $GLOBAL_SCORE%"
      
      #Comparer avec la baseline
      - name: Compare mutation score with baseline
        run: |
          CURRENT_SCORE=${{ steps.extract-score.outputs.global_score }}
          
          # V√©rifier si une baseline existe
          if [ ! -f .mutation-baseline/score.txt ]; then
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üÜï PREMI√àRE EX√âCUTION - CR√âATION DE LA BASELINE"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "Aucune baseline de mutation testing trouv√©e."
            echo "Cr√©ation de la baseline initiale avec un score de $CURRENT_SCORE%"
            echo ""
            mkdir -p .mutation-baseline
            echo "$CURRENT_SCORE" > .mutation-baseline/score.txt
            echo "Branche: ${{ github.ref_name }}" > .mutation-baseline/metadata.txt
            echo "Commit: ${{ github.sha }}" >> .mutation-baseline/metadata.txt
            echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .mutation-baseline/metadata.txt
            echo "Java: ${{ matrix.java-version }}" >> .mutation-baseline/metadata.txt
            echo ""
            echo "‚úÖ Baseline cr√©√©e avec succ√®s"
            echo "‚ö†Ô∏è  Les prochains commits seront compar√©s √† cette baseline"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            exit 0
          fi
          
          # Lire la baseline
          BASELINE_SCORE=$(cat .mutation-baseline/score.txt)
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîç V√âRIFICATION DU SCORE DE MUTATION GLOBAL"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üìà Score baseline : $BASELINE_SCORE%"
          echo "üìä Score actuel   : $CURRENT_SCORE%"
          echo ""
          
          # Comparer les scores (comparaison num√©rique)
          if [ "$CURRENT_SCORE" -lt "$BASELINE_SCORE" ]; then
            DIFF=$((BASELINE_SCORE - CURRENT_SCORE))
            echo "‚ùå ‚ùå ‚ùå √âCHEC ‚ùå ‚ùå ‚ùå"
            echo ""
            echo "Le score de mutation a BAISS√â de $DIFF point(s) !"
            echo ""
            echo "D√©tails :"
            echo "  ‚Ä¢ Score attendu (baseline) : $BASELINE_SCORE%"
            echo "  ‚Ä¢ Score obtenu            : $CURRENT_SCORE%"
            echo "  ‚Ä¢ R√©gression              : -$DIFF%"
            echo ""
            echo "‚ö†Ô∏è  Le build √©choue car la qualit√© des tests a diminu√©."
            echo "   Veuillez am√©liorer les tests avant de merger ce commit."
            echo ""
            echo "Baseline cr√©√©e depuis :"
            cat .mutation-baseline/metadata.txt
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            exit 1
          elif [ "$CURRENT_SCORE" -gt "$BASELINE_SCORE" ]; then
            DIFF=$((CURRENT_SCORE - BASELINE_SCORE))
            echo "‚úÖ ‚úÖ ‚úÖ AM√âLIORATION ‚úÖ ‚úÖ ‚úÖ"
            echo ""
            echo "Le score a augment√© de $DIFF point(s) ! üéâ"
            echo ""
            echo "üìù Mise √† jour de la baseline..."
            echo "$CURRENT_SCORE" > .mutation-baseline/score.txt
            echo "Branche: ${{ github.ref_name }}" > .mutation-baseline/metadata.txt
            echo "Commit: ${{ github.sha }}" >> .mutation-baseline/metadata.txt
            echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .mutation-baseline/metadata.txt
            echo "Java: ${{ matrix.java-version }}" >> .mutation-baseline/metadata.txt
            echo ""
            echo "‚úÖ Nouvelle baseline sauvegard√©e : $CURRENT_SCORE%"
          else
            echo "‚úÖ Score maintenu √† $CURRENT_SCORE%"
            echo ""
            echo "Le score de mutation est identique √† la baseline."
          fi
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      #Upload des rapports Pitest agr√©g√©s
      - name: Upload Pitest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-reports-all-modules-java-${{ matrix.java-version }}
          path: target/pit-reports-aggregate/
          retention-days: 30