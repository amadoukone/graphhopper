name: Build and Test
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24, 25-ea ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      
      - name: Build and Test ${{ matrix.java-version }}
        run: mvn -B clean test

  mutation-testing:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Cache mutation score baseline
        id: cache-mutation-baseline
        uses: actions/cache@v4
        with:
          path: .mutation-baseline
          key: mutation-baseline-${{ github.ref_name }}
          restore-keys: |
            mutation-baseline-

      #Compiler le projet (sans clean) avant Pitest
      - name: Compile project
        run: mvn -B install -DskipTests
      
      - name: Run Pitest mutation testing on all modules
        run: |
          # Liste des modules Ã  tester (sans web-bundle qui est lourd)
          MODULES="web-api core reader-gtfs tools map-matching client-hc navigation web example"
          
          echo "ğŸ§¬ DÃ©marrage du mutation testing module par module"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          for module in $MODULES; do
            echo ""
            echo "ğŸ“¦ Testing module: $module"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if mvn -B org.pitest:pitest-maven:mutationCoverage -DargLine="" -pl $module -am; then
              echo "âœ… Module $module : SUCCÃˆS"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âŒ Module $module : Ã‰CHEC (continuer quand mÃªme)"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ©sumÃ© du mutation testing :"
          echo "   âœ… SuccÃ¨s : $SUCCESS_COUNT modules"
          echo "   âŒ Ã‰checs : $FAIL_COUNT modules"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Aggregate Pitest reports
        run: |
          mkdir -p target/pit-reports-aggregate
          
          find . -path "*/target/pit-reports/*/index.html" -type f | while read report; do
            module_name=$(echo "$report" | sed 's|./||' | sed 's|/target/.*||')
            echo "ğŸ“¦ TrouvÃ© rapport pour module: $module_name"
            
            mkdir -p "target/pit-reports-aggregate/$module_name"
            cp -r "$(dirname "$report")"/* "target/pit-reports-aggregate/$module_name/"
          done
          
          echo "âœ… Rapports agrÃ©gÃ©s dans target/pit-reports-aggregate/"
          ls -la target/pit-reports-aggregate/ || echo "Aucun rapport trouvÃ©"
      
      - name: Extract global mutation score
        id: extract-score
        run: |
          REPORT_FILES=$(find . -path "*/target/pit-reports/*/index.html" -type f)
          
          if [ -z "$REPORT_FILES" ]; then
            echo "âŒ Aucun rapport Pitest trouvÃ©"
            exit 1
          fi
          
          echo "ğŸ“„ Rapports trouvÃ©s :"
          echo "$REPORT_FILES"
          echo ""
          
          TOTAL_MUTATIONS=0
          TOTAL_KILLED=0
          
          while IFS= read -r report; do
            module=$(echo "$report" | sed 's|./||' | sed 's|/target/.*||')
            echo "ğŸ“Š Analyse du module: $module"
            
            xml_report="${report/index.html/mutations.xml}"
            
            if [ -f "$xml_report" ]; then
              mutations=$(grep -oP 'detected="\K\d+' "$xml_report" | awk '{s+=$1} END {print s}')
              killed=$(grep -oP 'status="KILLED"' "$xml_report" | wc -l)
              
              TOTAL_MUTATIONS=$((TOTAL_MUTATIONS + mutations))
              TOTAL_KILLED=$((TOTAL_KILLED + killed))
              
              echo "  Mutations: $mutations, TuÃ©es: $killed"
            fi
          done <<< "$REPORT_FILES"
          
          echo ""
          echo "ğŸ“ˆ Statistiques globales :"
          echo "  Total mutations : $TOTAL_MUTATIONS"
          echo "  Total tuÃ©es     : $TOTAL_KILLED"
          
          if [ "$TOTAL_MUTATIONS" -eq 0 ]; then
            GLOBAL_SCORE=0
            echo "âš ï¸  Aucune mutation dÃ©tectÃ©e"
          else
            GLOBAL_SCORE=$((TOTAL_KILLED * 100 / TOTAL_MUTATIONS))
          fi
          
          echo "global_score=$GLOBAL_SCORE" >> $GITHUB_OUTPUT
          echo ""
          echo "ğŸ¯ Score de mutation global : $GLOBAL_SCORE%"
      
      - name: Compare mutation score with baseline
        run: |
          CURRENT_SCORE=${{ steps.extract-score.outputs.global_score }}
          
          if [ ! -f .mutation-baseline/score.txt ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ†• PREMIÃˆRE EXÃ‰CUTION - CRÃ‰ATION DE LA BASELINE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Aucune baseline de mutation testing trouvÃ©e."
            echo "CrÃ©ation de la baseline initiale avec un score de $CURRENT_SCORE%"
            echo ""
            mkdir -p .mutation-baseline
            echo "$CURRENT_SCORE" > .mutation-baseline/score.txt
            echo "Branche: ${{ github.ref_name }}" > .mutation-baseline/metadata.txt
            echo "Commit: ${{ github.sha }}" >> .mutation-baseline/metadata.txt
            echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .mutation-baseline/metadata.txt
            echo "Java: 21 (pour Pitest)" >> .mutation-baseline/metadata.txt
            echo ""
            echo "âœ… Baseline crÃ©Ã©e avec succÃ¨s"
            echo "âš ï¸  Les prochains commits seront comparÃ©s Ã  cette baseline"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          fi
          
          BASELINE_SCORE=$(cat .mutation-baseline/score.txt)
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” VÃ‰RIFICATION DU SCORE DE MUTATION GLOBAL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ˆ Score baseline : $BASELINE_SCORE%"
          echo "ğŸ“Š Score actuel   : $CURRENT_SCORE%"
          echo ""
          
          if [ "$CURRENT_SCORE" -lt "$BASELINE_SCORE" ]; then
            DIFF=$((BASELINE_SCORE - CURRENT_SCORE))
            echo "âŒ âŒ âŒ Ã‰CHEC âŒ âŒ âŒ"
            echo ""
            echo "Le score de mutation a BAISSÃ‰ de $DIFF point(s) !"
            echo ""
            echo "DÃ©tails :"
            echo "  â€¢ Score attendu (baseline) : $BASELINE_SCORE%"
            echo "  â€¢ Score obtenu            : $CURRENT_SCORE%"
            echo "  â€¢ RÃ©gression              : -$DIFF%"
            echo ""
            echo "âš ï¸  Le build Ã©choue car la qualitÃ© des tests a diminuÃ©."
            echo "   Veuillez amÃ©liorer les tests avant de merger ce commit."
            echo ""
            echo "Baseline crÃ©Ã©e depuis :"
            cat .mutation-baseline/metadata.txt
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          elif [ "$CURRENT_SCORE" -gt "$BASELINE_SCORE" ]; then
            DIFF=$((CURRENT_SCORE - BASELINE_SCORE))
            echo "âœ… âœ… âœ… AMÃ‰LIORATION âœ… âœ… âœ…"
            echo ""
            echo "Le score a augmentÃ© de $DIFF point(s) ! ğŸ‰"
            echo ""
            echo "ğŸ“ Mise Ã  jour de la baseline..."
            echo "$CURRENT_SCORE" > .mutation-baseline/score.txt
            echo "Branche: ${{ github.ref_name }}" > .mutation-baseline/metadata.txt
            echo "Commit: ${{ github.sha }}" >> .mutation-baseline/metadata.txt
            echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .mutation-baseline/metadata.txt
            echo "Java: 21 (pour Pitest)" >> .mutation-baseline/metadata.txt
            echo ""
            echo "âœ… Nouvelle baseline sauvegardÃ©e : $CURRENT_SCORE%"
          else
            echo "âœ… Score maintenu Ã  $CURRENT_SCORE%"
            echo ""
            echo "Le score de mutation est identique Ã  la baseline."
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Upload Pitest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-reports-all-modules
          path: target/pit-reports-aggregate/
          retention-days: 30