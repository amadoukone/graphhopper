name: Mutation Testing

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  mutation-testing:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout current commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Build project
        run: mvn clean install -DskipTests -B
      
      - name: Run mutation testing (core module)
        id: run-current-pit
        run: |
          set +e
          cd core
          mvn org.pitest:pitest-maven:mutationCoverage -B 2>&1 | tee pit-output.log
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Mutation testing completed"
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Mutation testing failed"
            tail -100 pit-output.log
            exit 1
          fi
      
      - name: Extract current mutation score
        id: current-score
        if: steps.run-current-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SURVIVED=$(grep -o "status='SURVIVED'" "$MUTATION_FILE" | wc -l)
          
          SCORE=$((TOTAL > 0 ? KILLED * 100 / TOTAL : 0))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Mutation Score: $SCORE% ($KILLED/$TOTAL killed)"
      
      - name: Save current mutation report
        if: steps.current-score.outputs.found == 'true'
        run: |
          mkdir -p mutation-reports/current
          cp -r core/target/pit-reports/* mutation-reports/current/
      
      - name: Check parent commit
        id: check-parent
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "commit=$(git rev-parse HEAD^)" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: git checkout ${{ steps.check-parent.outputs.commit }}
      
      - name: Build parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: mvn clean install -DskipTests -B
      
      - name: Run mutation testing on parent
        if: steps.check-parent.outputs.exists == 'true'
        id: run-parent-pit
        run: |
          set +e
          cd core
          mvn org.pitest:pitest-maven:mutationCoverage -B 2>&1 | tee pit-parent-output.log
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          exit 0
      
      - name: Extract parent mutation score
        id: parent-score
        if: steps.check-parent.outputs.exists == 'true' && steps.run-parent-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SCORE=$((TOTAL > 0 ? KILLED * 100 / TOTAL : 0))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
      
      - name: Compare scores and fail if decreased
        if: steps.current-score.outputs.found == 'true'
        run: |
          CURRENT=${{ steps.current-score.outputs.score }}
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   MUTATION TESTING RESULTS (Core)   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Current: ${{ steps.current-score.outputs.killed }}/${{ steps.current-score.outputs.total }} killed ($CURRENT%)"
          
          if [ "${{ steps.parent-score.outputs.found }}" == "true" ]; then
            PARENT=${{ steps.parent-score.outputs.score }}
            DIFF=$((CURRENT - PARENT))
            
            echo "Parent:  ${{ steps.parent-score.outputs.killed }}/${{ steps.parent-score.outputs.total }} killed ($PARENT%)"
            echo "Diff:    ${DIFF}%"
            echo ""
            
            if [ $CURRENT -lt $PARENT ]; then
              echo "âŒ Score decreased from $PARENT% to $CURRENT%"
              exit 1
            elif [ $CURRENT -eq $PARENT ]; then
              echo "âœ… Score maintained at $CURRENT%"
            else
              echo "ğŸ‰ Score improved from $PARENT% to $CURRENT%!"
            fi
          else
            echo ""
            echo "âœ… Baseline established at $CURRENT%"
          fi
      
      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-reports
          path: |
            mutation-reports/
            core/target/pit-reports/
            core/*.log
          retention-days: 30
      
      - name: Comment PR
        if: github.event_name == 'pull_request' && steps.current-score.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = {
              score: parseInt('${{ steps.current-score.outputs.score }}'),
              killed: parseInt('${{ steps.current-score.outputs.killed }}'),
              total: parseInt('${{ steps.current-score.outputs.total }}')
            };
            
            let body = `## ğŸ§¬ Mutation Testing Results\n\n`;
            
            if ('${{ steps.parent-score.outputs.found }}' === 'true') {
              const parent = {
                score: parseInt('${{ steps.parent-score.outputs.score }}'),
                killed: parseInt('${{ steps.parent-score.outputs.killed }}'),
                total: parseInt('${{ steps.parent-score.outputs.total }}')
              };
              const diff = current.score - parent.score;
              const emoji = diff < 0 ? 'ğŸ”´' : diff > 0 ? 'ğŸŸ¢' : 'âšª';
              
              body += `| | Parent | Current | Diff |\n|---|---|---|---|\n`;
              body += `| Score | ${parent.score}% | ${current.score}% | ${emoji} ${diff > 0 ? '+' : ''}${diff}% |\n`;
              body += `| Killed | ${parent.killed}/${parent.total} | ${current.killed}/${current.total} | ${current.killed - parent.killed} |\n`;
            } else {
              body += `**Score:** ${current.score}% (${current.killed}/${current.total} killed)\n\n`;
              body += `âœ… Baseline established`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });