name: Mutation Testing

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  mutation-testing:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # AugmentÃ© Ã  4h
    
    steps:
      - name: Checkout current commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Java with more memory
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
      
      - name: Configure Maven with more memory
        run: |
          mkdir -p .mvn
          cat > .mvn/maven.config << 'EOF'
          -B
          --no-transfer-progress
          EOF
          
          cat > .mvn/jvm.config << 'EOF'
          -Xmx4096m
          -Xms1024m
          EOF
          
          echo "=== Maven Configuration ==="
          cat .mvn/maven.config
          cat .mvn/jvm.config
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Build project
        run: mvn clean install -DskipTests
      
      - name: Run mutation testing (core module)
        id: run-current-pit
        run: |
          set +e
          cd core
          
          echo "Starting mutation testing at $(date)"
          echo "Available memory: $(free -h)"
          
          mvn org.pitest:pitest-maven:mutationCoverage 2>&1 | tee pit-output.log
          
          EXIT_CODE=$?
          
          echo "Mutation testing finished at $(date) with exit code $EXIT_CODE"
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Mutation report generated"
            
            # Afficher un rÃ©sumÃ© des erreurs mÃ©moire
            MEMORY_ERRORS=$(grep -c "MEMORY_ERROR" pit-output.log || echo "0")
            echo "Memory errors encountered: $MEMORY_ERRORS"
            
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ No mutation report generated"
            
            echo "=== Last 100 lines of output ==="
            tail -100 pit-output.log
            
            echo "=== Memory errors ==="
            grep "MEMORY_ERROR\|OutOfMemory" pit-output.log || echo "No memory errors found in log"
            
            exit 1
          fi
      
      - name: Extract current mutation score
        id: current-score
        if: steps.run-current-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SURVIVED=$(grep -o "status='SURVIVED'" "$MUTATION_FILE" | wc -l)
          TIMEOUT=$(grep -o "status='TIMED_OUT'" "$MUTATION_FILE" | wc -l || echo "0")
          MEMORY=$(grep -o "status='MEMORY_ERROR'" "$MUTATION_FILE" | wc -l || echo "0")
          
          SCORE=$((TOTAL > 0 ? KILLED * 100 / TOTAL : 0))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
          echo "timeout=$TIMEOUT" >> $GITHUB_OUTPUT
          echo "memory=$MEMORY" >> $GITHUB_OUTPUT
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   MUTATION TESTING RESULTS (Current)   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Total mutants:    $TOTAL"
          echo "Killed:           $KILLED ($SCORE%)"
          echo "Survived:         $SURVIVED"
          echo "Timed out:        $TIMEOUT"
          echo "Memory errors:    $MEMORY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Save current mutation report
        if: steps.current-score.outputs.found == 'true'
        run: |
          mkdir -p mutation-reports/current
          cp -r core/target/pit-reports/* mutation-reports/current/
      
      - name: Check parent commit
        id: check-parent
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "commit=$(git rev-parse HEAD^)" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: git checkout ${{ steps.check-parent.outputs.commit }}
      
      - name: Build parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: mvn clean install -DskipTests
      
      - name: Run mutation testing on parent
        if: steps.check-parent.outputs.exists == 'true'
        id: run-parent-pit
        run: |
          set +e
          cd core
          
          echo "Starting parent mutation testing at $(date)"
          
          mvn org.pitest:pitest-maven:mutationCoverage 2>&1 | tee pit-parent-output.log
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Parent report generated"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No parent report"
          fi
          exit 0
      
      - name: Extract parent mutation score
        id: parent-score
        if: steps.check-parent.outputs.exists == 'true' && steps.run-parent-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SCORE=$((TOTAL > 0 ? KILLED * 100 / TOTAL : 0))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          echo "Parent: $KILLED/$TOTAL killed ($SCORE%)"
      
      - name: Compare scores and fail if decreased
        if: steps.current-score.outputs.found == 'true'
        run: |
          CURRENT=${{ steps.current-score.outputs.score }}
          CURRENT_KILLED=${{ steps.current-score.outputs.killed }}
          CURRENT_TOTAL=${{ steps.current-score.outputs.total }}
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       MUTATION TESTING COMPARISON (Core)        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Current: $CURRENT_KILLED/$CURRENT_TOTAL killed ($CURRENT%)"
          
          if [ "${{ steps.parent-score.outputs.found }}" == "true" ]; then
            PARENT=${{ steps.parent-score.outputs.score }}
            PARENT_KILLED=${{ steps.parent-score.outputs.killed }}
            PARENT_TOTAL=${{ steps.parent-score.outputs.total }}
            DIFF=$((CURRENT - PARENT))
            
            echo "Parent:  $PARENT_KILLED/$PARENT_TOTAL killed ($PARENT%)"
            echo "Diff:    ${DIFF}%"
            echo ""
            
            if [ $CURRENT -lt $PARENT ]; then
              echo "âŒ FAILURE: Score decreased from $PARENT% to $CURRENT%"
              echo ""
              echo "Your changes reduced mutation testing quality."
              echo "Please review survived mutants and improve tests."
              exit 1
            elif [ $CURRENT -eq $PARENT ]; then
              echo "âœ… SUCCESS: Score maintained at $CURRENT%"
            else
              echo "ğŸ‰ SUCCESS: Score improved from $PARENT% to $CURRENT%!"
              echo "You killed $((CURRENT_KILLED - PARENT_KILLED)) more mutants!"
            fi
          else
            echo ""
            echo "âœ… Baseline established at $CURRENT%"
          fi
      
      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-reports
          path: |
            mutation-reports/
            core/target/pit-reports/
            core/*.log
          retention-days: 30
      
      - name: Comment PR
        if: github.event_name == 'pull_request' && steps.current-score.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = {
              score: parseInt('${{ steps.current-score.outputs.score }}'),
              killed: parseInt('${{ steps.current-score.outputs.killed }}'),
              total: parseInt('${{ steps.current-score.outputs.total }}'),
              survived: parseInt('${{ steps.current-score.outputs.survived }}'),
              timeout: parseInt('${{ steps.current-score.outputs.timeout }}'),
              memory: parseInt('${{ steps.current-score.outputs.memory }}')
            };
            
            let body = `## ğŸ§¬ Mutation Testing Results (Core Module)\n\n`;
            
            if ('${{ steps.parent-score.outputs.found }}' === 'true') {
              const parent = {
                score: parseInt('${{ steps.parent-score.outputs.score }}'),
                killed: parseInt('${{ steps.parent-score.outputs.killed }}'),
                total: parseInt('${{ steps.parent-score.outputs.total }}')
              };
              const diff = current.score - parent.score;
              const emoji = diff < 0 ? 'ğŸ”´' : diff > 0 ? 'ğŸŸ¢' : 'âšª';
              
              body += `| Metric | Parent | Current | Diff |\n`;
              body += `|--------|--------|---------|------|\n`;
              body += `| **Score** | ${parent.score}% | ${current.score}% | ${emoji} ${diff > 0 ? '+' : ''}${diff}% |\n`;
              body += `| **Killed** | ${parent.killed}/${parent.total} | ${current.killed}/${current.total} | ${current.killed - parent.killed} |\n`;
              body += `| **Survived** | ${parent.total - parent.killed} | ${current.survived} | ${current.survived - (parent.total - parent.killed)} |\n\n`;
            } else {
              body += `| Metric | Value |\n`;
              body += `|--------|-------|\n`;
              body += `| **Score** | ${current.score}% |\n`;
              body += `| **Killed** | ${current.killed}/${current.total} |\n`;
              body += `| **Survived** | ${current.survived} |\n\n`;
              body += `âœ… Baseline established\n\n`;
            }
            
            if (current.timeout > 0 || current.memory > 0) {
              body += `\nâš ï¸ **Issues:**\n`;
              if (current.timeout > 0) body += `- ${current.timeout} mutation(s) timed out\n`;
              if (current.memory > 0) body += `- ${current.memory} mutation(s) had memory errors\n`;
            }
            
            body += `\n---\n*Powered by [PIT](https://pitest.org/)*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });