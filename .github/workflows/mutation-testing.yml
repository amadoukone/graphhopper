name: Mutation Testing

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  mutation-testing:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout current commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
      
      - name: Configure Maven JVM options
        run: |
          # Cr√©er le dossier .mvn s'il n'existe pas
          mkdir -p .mvn
          
          # Cr√©er un fichier jvm.config qui √©crase les options par d√©faut
          echo "-Xmx2048m" > .mvn/jvm.config
          echo "-Xms512m" >> .mvn/jvm.config
          
          # V√©rifier le contenu
          echo "=== Maven JVM Config ==="
          cat .mvn/jvm.config
          
          # D√©sactiver les variables d'environnement Maven probl√©matiques
          echo "MAVEN_OPTS=" >> $GITHUB_ENV
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      
      - name: Build and test project (current commit)
        run: mvn clean test -B
      
      - name: Install project without tests
        run: mvn install -DskipTests -B
      
      - name: Run mutation testing on current commit (core module only for now)
        id: run-current-pit
        run: |
          set +e
          cd core
          
          # S'assurer qu'on n'h√©rite pas d'options JVM probl√©matiques
          unset MAVEN_OPTS
          
          mvn org.pitest:pitest-maven:mutationCoverage \
            -DargLine="-Xmx2048m -Xms512m" \
            -Dpit.threads=2 \
            -B 2>&1 | tee pit-output.log
          
          EXIT_CODE=$?
          
          # V√©rifier si un rapport a √©t√© g√©n√©r√©
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Mutation report generated successfully"
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå No mutation report generated"
            
            # Afficher les derni√®res lignes pour debug
            echo "=== Last 50 lines of output ==="
            tail -50 pit-output.log
            exit 1
          fi
      
      - name: Extract current mutation score
        id: current-score
        if: steps.run-current-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "No mutation file found"
            exit 1
          fi
          
          # Compter les mutants
          TOTAL_MUTANTS=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED_MUTANTS=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          
          if [ $TOTAL_MUTANTS -eq 0 ]; then
            MUTATION_SCORE=0
          else
            MUTATION_SCORE=$((KILLED_MUTANTS * 100 / TOTAL_MUTANTS))
          fi
          
          echo "Current commit: $KILLED_MUTANTS/$TOTAL_MUTANTS mutants killed"
          echo "Current mutation score: $MUTATION_SCORE%"
          echo "score=$MUTATION_SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED_MUTANTS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_MUTANTS" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT
      
      - name: Save current mutation report
        if: steps.current-score.outputs.found == 'true'
        run: |
          mkdir -p mutation-reports/current
          cp -r core/target/pit-reports/* mutation-reports/current/ 2>/dev/null || true
      
      - name: Check if parent commit exists
        id: check-parent
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            PARENT=$(git rev-parse HEAD^)
            echo "commit=$PARENT" >> $GITHUB_OUTPUT
            echo "Parent commit: $PARENT"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No parent commit (first commit)"
          fi
      
      - name: Checkout parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: |
          git checkout ${{ steps.check-parent.outputs.commit }}
      
      - name: Build and test project (parent commit)
        if: steps.check-parent.outputs.exists == 'true'
        run: |
          mvn clean test -B
          mvn install -DskipTests -B
      
      - name: Run mutation testing on parent commit
        if: steps.check-parent.outputs.exists == 'true'
        id: run-parent-pit
        run: |
          set +e
          cd core
          
          unset MAVEN_OPTS
          
          mvn org.pitest:pitest-maven:mutationCoverage \
            -DargLine="-Xmx2048m -Xms512m" \
            -Dpit.threads=2 \
            -B 2>&1 | tee pit-parent-output.log
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Parent mutation report generated"
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No mutation report for parent"
            exit 0
          fi
      
      - name: Extract parent mutation score
        id: parent-score
        if: steps.check-parent.outputs.exists == 'true' && steps.run-parent-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          TOTAL_MUTANTS=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED_MUTANTS=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          
          if [ $TOTAL_MUTANTS -eq 0 ]; then
            MUTATION_SCORE=0
          else
            MUTATION_SCORE=$((KILLED_MUTANTS * 100 / TOTAL_MUTANTS))
          fi
          
          echo "Parent commit: $KILLED_MUTANTS/$TOTAL_MUTANTS mutants killed"
          echo "Parent mutation score: $MUTATION_SCORE%"
          echo "score=$MUTATION_SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED_MUTANTS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_MUTANTS" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT
      
      - name: Compare mutation scores
        if: steps.current-score.outputs.found == 'true'
        run: |
          CURRENT_SCORE=${{ steps.current-score.outputs.score }}
          CURRENT_KILLED=${{ steps.current-score.outputs.killed }}
          CURRENT_TOTAL=${{ steps.current-score.outputs.total }}
          
          echo "=================================="
          echo "üìä MUTATION TESTING RESULTS"
          echo "=================================="
          
          # Si pas de parent ou parent sans rapport
          if [ "${{ steps.check-parent.outputs.exists }}" != "true" ] || [ "${{ steps.parent-score.outputs.found }}" != "true" ]; then
            echo "Current commit: $CURRENT_KILLED/$CURRENT_TOTAL mutants killed ($CURRENT_SCORE%)"
            echo "Parent commit:  No comparison available"
            echo "=================================="
            echo "‚úÖ SUCCESS: Baseline established at $CURRENT_SCORE%"
            exit 0
          fi
          
          PARENT_SCORE=${{ steps.parent-score.outputs.score }}
          PARENT_KILLED=${{ steps.parent-score.outputs.killed }}
          PARENT_TOTAL=${{ steps.parent-score.outputs.total }}
          DIFF=$((CURRENT_SCORE - PARENT_SCORE))
          
          echo "Parent commit:  $PARENT_KILLED/$PARENT_TOTAL mutants killed ($PARENT_SCORE%)"
          echo "Current commit: $CURRENT_KILLED/$CURRENT_TOTAL mutants killed ($CURRENT_SCORE%)"
          echo "Difference:     ${DIFF}%"
          echo "=================================="
          
          if [ $CURRENT_SCORE -lt $PARENT_SCORE ]; then
            echo "‚ùå FAILURE: Mutation score DECREASED from $PARENT_SCORE% to $CURRENT_SCORE%"
            echo ""
            echo "The build fails because mutation testing quality has degraded."
            echo "Please improve your tests to kill more mutants."
            exit 1
          elif [ $CURRENT_SCORE -eq $PARENT_SCORE ]; then
            echo "‚úÖ SUCCESS: Mutation score MAINTAINED at $CURRENT_SCORE%"
          else
            echo "‚úÖ SUCCESS: Mutation score IMPROVED from $PARENT_SCORE% to $CURRENT_SCORE% üéâ"
          fi
      
      - name: Upload mutation reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-reports
          path: |
            mutation-reports/
            core/target/pit-reports/
            core/pit-output.log
            core/pit-parent-output.log
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.current-score.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const currentScore = ${{ steps.current-score.outputs.score }};
            const currentKilled = ${{ steps.current-score.outputs.killed }};
            const currentTotal = ${{ steps.current-score.outputs.total }};
            const hasParent = '${{ steps.parent-score.outputs.found }}' === 'true';
            
            let body = `## üß¨ Mutation Testing Results (Core Module)\n\n`;
            
            if (hasParent) {
              const parentScore = ${{ steps.parent-score.outputs.score }};
              const parentKilled = ${{ steps.parent-score.outputs.killed }};
              const parentTotal = ${{ steps.parent-score.outputs.total }};
              const diff = currentScore - parentScore;
              
              let emoji = '‚úÖ';
              let status = 'maintained';
              if (diff < 0) {
                emoji = '‚ùå';
                status = 'decreased';
              } else if (diff > 0) {
                emoji = 'üéâ';
                status = 'improved';
              }
              
              body += `| Metric | Parent | Current | Diff |
            |--------|--------|---------|------|
            | **Score** | ${parentScore}% | ${currentScore}% | ${diff > 0 ? '+' : ''}${diff}% |
            | **Killed** | ${parentKilled}/${parentTotal} | ${currentKilled}/${currentTotal} | ${currentKilled - parentKilled} |

            **Status:** Score has **${status}** ${emoji}`;
                        } else {
                          body += `| Metric | Value |
            |--------|-------|
            | **Score** | ${currentScore}% |
            | **Killed** | ${currentKilled}/${currentTotal} |

            **Status:** Baseline established ‚úÖ`;
                        }
                        
                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: body
                        });