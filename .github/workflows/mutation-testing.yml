name: Mutation Testing

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  mutation-testing:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout current commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Java (without problematic flags)
        uses: actions/setup-java@v4
        with:
          java-version: '17.0.8'  # Version spÃ©cifique plus ancienne
          distribution: temurin
          # DÃ©sactiver les features rÃ©centes
          java-package: jdk
      
      - name: Verify Java setup
        run: |
          echo "=== Java Version ==="
          java -version
          echo ""
          echo "=== Java Options ==="
          echo "JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS:-not set}"
          echo "MAVEN_OPTS: ${MAVEN_OPTS:-not set}"
          echo "_JAVA_OPTIONS: ${_JAVA_OPTIONS:-not set}"
      
      - name: Configure environment for PIT
        run: |
          # Forcer Maven Ã  ignorer toutes les options hÃ©ritÃ©es
          echo "MAVEN_OPTS=-Xmx2048m -Xms512m" >> $GITHUB_ENV
          
          # CrÃ©er .mvn/jvm.config
          mkdir -p .mvn
          cat > .mvn/jvm.config << 'EOF'
          -Xmx2048m
          -Xms512m
          EOF
          
          # CrÃ©er .mvn/maven.config pour forcer certaines options
          cat > .mvn/maven.config << 'EOF'
          -B
          --no-transfer-progress
          EOF
          
          echo "=== Maven Config Files ==="
          cat .mvn/jvm.config
          cat .mvn/maven.config
      
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Build and test project (current commit)
        run: mvn clean test
      
      - name: Install project without tests
        run: mvn install -DskipTests
      
      - name: Run mutation testing on current commit (core module)
        id: run-current-pit
        run: |
          set +e
          cd core
          
          # DerniÃ¨re tentative : forcer les options via properties systÃ¨me
          mvn org.pitest:pitest-maven:mutationCoverage \
            -Dpit.jvmArgs="-Xmx2048m,-Xms512m" \
            2>&1 | tee pit-output.log
          
          EXIT_CODE=$?
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Mutation report generated successfully"
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ No mutation report generated"
            
            echo "=== Last 100 lines of output ==="
            tail -100 pit-output.log
            exit 1
          fi
      
      - name: Extract current mutation score
        id: current-score
        if: steps.run-current-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "No mutation file found"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL_MUTANTS=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED_MUTANTS=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SURVIVED_MUTANTS=$(grep -o "status='SURVIVED'" "$MUTATION_FILE" | wc -l)
          
          if [ $TOTAL_MUTANTS -eq 0 ]; then
            MUTATION_SCORE=0
          else
            MUTATION_SCORE=$((KILLED_MUTANTS * 100 / TOTAL_MUTANTS))
          fi
          
          echo "=================================="
          echo "ğŸ“Š Current Commit Mutation Results"
          echo "=================================="
          echo "Total mutants:    $TOTAL_MUTANTS"
          echo "Killed mutants:   $KILLED_MUTANTS"
          echo "Survived mutants: $SURVIVED_MUTANTS"
          echo "Mutation score:   $MUTATION_SCORE%"
          echo "=================================="
          
          echo "score=$MUTATION_SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED_MUTANTS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_MUTANTS" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED_MUTANTS" >> $GITHUB_OUTPUT
      
      - name: Save current mutation report
        if: steps.current-score.outputs.found == 'true'
        run: |
          mkdir -p mutation-reports/current
          cp -r core/target/pit-reports/* mutation-reports/current/
      
      - name: Check if parent commit exists
        id: check-parent
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            PARENT=$(git rev-parse HEAD^)
            echo "commit=$PARENT" >> $GITHUB_OUTPUT
            echo "âœ… Parent commit: $PARENT"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No parent commit"
          fi
      
      - name: Checkout parent commit
        if: steps.check-parent.outputs.exists == 'true'
        run: |
          git checkout ${{ steps.check-parent.outputs.commit }}
      
      - name: Build and test project (parent commit)
        if: steps.check-parent.outputs.exists == 'true'
        run: |
          mvn clean test
          mvn install -DskipTests
      
      - name: Run mutation testing on parent commit
        if: steps.check-parent.outputs.exists == 'true'
        id: run-parent-pit
        run: |
          set +e
          cd core
          
          mvn org.pitest:pitest-maven:mutationCoverage \
            -Dpit.jvmArgs="-Xmx2048m,-Xms512m" \
            2>&1 | tee pit-parent-output.log
          
          if find target/pit-reports -name "mutations.xml" 2>/dev/null | grep -q .; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Parent report generated"
            exit 0
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No parent report"
            exit 0
          fi
      
      - name: Extract parent mutation score
        id: parent-score
        if: steps.check-parent.outputs.exists == 'true' && steps.run-parent-pit.outputs.success == 'true'
        run: |
          cd core
          MUTATION_FILE=$(find target/pit-reports -name "mutations.xml")
          
          if [ -z "$MUTATION_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          
          TOTAL_MUTANTS=$(grep -o "<mutation detected='[^']*' status='[^']*'" "$MUTATION_FILE" | wc -l)
          KILLED_MUTANTS=$(grep -o "status='KILLED'" "$MUTATION_FILE" | wc -l)
          SURVIVED_MUTANTS=$(grep -o "status='SURVIVED'" "$MUTATION_FILE" | wc -l)
          
          if [ $TOTAL_MUTANTS -eq 0 ]; then
            MUTATION_SCORE=0
          else
            MUTATION_SCORE=$((KILLED_MUTANTS * 100 / TOTAL_MUTANTS))
          fi
          
          echo "score=$MUTATION_SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED_MUTANTS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_MUTANTS" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED_MUTANTS" >> $GITHUB_OUTPUT
      
      - name: Compare mutation scores
        if: steps.current-score.outputs.found == 'true'
        run: |
          CURRENT_SCORE=${{ steps.current-score.outputs.score }}
          CURRENT_KILLED=${{ steps.current-score.outputs.killed }}
          CURRENT_TOTAL=${{ steps.current-score.outputs.total }}
          CURRENT_SURVIVED=${{ steps.current-score.outputs.survived }}
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       MUTATION TESTING COMPARISON (Core)          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ "${{ steps.check-parent.outputs.exists }}" != "true" ] || [ "${{ steps.parent-score.outputs.found }}" != "true" ]; then
            echo "ğŸ“Š Current: $CURRENT_KILLED/$CURRENT_TOTAL killed ($CURRENT_SCORE%)"
            echo "ğŸ“‹ Parent: No comparison available"
            echo ""
            echo "âœ… Baseline established at $CURRENT_SCORE%"
            exit 0
          fi
          
          PARENT_SCORE=${{ steps.parent-score.outputs.score }}
          PARENT_KILLED=${{ steps.parent-score.outputs.killed }}
          PARENT_TOTAL=${{ steps.parent-score.outputs.total }}
          DIFF=$((CURRENT_SCORE - PARENT_SCORE))
          
          echo "ğŸ“Š Current: $CURRENT_KILLED/$CURRENT_TOTAL killed ($CURRENT_SCORE%)"
          echo "ğŸ“‹ Parent:  $PARENT_KILLED/$PARENT_TOTAL killed ($PARENT_SCORE%)"
          echo "ğŸ“ˆ Diff:    ${DIFF}%"
          echo ""
          
          if [ $CURRENT_SCORE -lt $PARENT_SCORE ]; then
            echo "âŒ FAILURE: Score decreased from $PARENT_SCORE% to $CURRENT_SCORE%"
            exit 1
          elif [ $CURRENT_SCORE -eq $PARENT_SCORE ]; then
            echo "âœ… Score maintained at $CURRENT_SCORE%"
          else
            echo "ğŸ‰ Score improved from $PARENT_SCORE% to $CURRENT_SCORE%"
          fi
      
      - name: Upload mutation reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-reports
          path: |
            mutation-reports/
            core/target/pit-reports/
            core/pit-output.log
            core/pit-parent-output.log
          retention-days: 30
      
      - name: Comment PR
        if: github.event_name == 'pull_request' && steps.current-score.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = {
              score: parseInt('${{ steps.current-score.outputs.score }}'),
              killed: parseInt('${{ steps.current-score.outputs.killed }}'),
              total: parseInt('${{ steps.current-score.outputs.total }}'),
              survived: parseInt('${{ steps.current-score.outputs.survived }}')
            };
            const hasParent = '${{ steps.parent-score.outputs.found }}' === 'true';
            
            let body = `## ğŸ§¬ Mutation Testing (Core Module)\n\n`;
            
            if (hasParent) {
              const parent = {
                score: parseInt('${{ steps.parent-score.outputs.score }}'),
                killed: parseInt('${{ steps.parent-score.outputs.killed }}'),
                total: parseInt('${{ steps.parent-score.outputs.total }}')
              };
              const diff = current.score - parent.score;
              const emoji = diff < 0 ? 'âŒ' : diff > 0 ? 'ğŸ‰' : 'âœ…';
              
              body += `| Metric | Parent | Current | Diff |
            |--------|--------|---------|------|
            | Score | ${parent.score}% | ${current.score}% | ${emoji} ${diff > 0 ? '+' : ''}${diff}% |
            | Killed | ${parent.killed}/${parent.total} | ${current.killed}/${current.total} | ${current.killed - parent.killed} |\n`;
            } else {
              body += `| Metric | Value |
            |--------|-------|
            | Score | ${current.score}% |
            | Killed | ${current.killed}/${current.total} |\n\nâœ… Baseline established`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });